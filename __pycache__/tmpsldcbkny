


from particles.photons import Photon
import mayavi.mlab as mlab
import numpy as np

from geometry.primitives cimport Volume, UnboundedVolume

cdef class DirectionalPointSource:
    cdef double[:] xx, yy, zz, ss, CONNECT
    
    
    @staticmethod
    def new(SPACE, CURRENT, N):
        return DirectionalPointSource._new(SPACE, CURRENT, N)
    
    @staticmethod
    cdef DirectionalPointSource _new(UnboundedVolume SPACE, Volume CURRENT, int N):
        
        cdef DirectionalPointSource self
        self = <DirectionalPointSource>DirectionalPointSource.__new__(DirectionalPointSource)
        
        cdef int index = 0
        cdef list x, y, z, connections, s
        x = list()
        y = list()
        z = list()
        connections = list()
        s = list()
        cdef list X, Y, Z
        
        cdef int i
        for i in range(N):
        
            p = Photon.new(SPACE, CURRENT)
            p.run()
            X, Y, Z = p.getTrack()
            N = len(X)
            S = p.getEnergy()
            S.append(10)
            
            x.append(np.array(X))
            y.append(np.array(Y))
            z.append(np.array(Z))
            s.append(np.array(S))
            
            connections.append(np.vstack(
                            [np.arange(index,   index + N - 1.5),
                            np.arange(index + 1, index + N - .5)]
                                ).T)
        
        
            index += N
    
        print("FINISHED SIMULATION")
    
        # Now collapse all positions, scalars and connections in big arrays
        
        self.xx = np.hstack(x)
        self.yy = np.hstack(y)
        self.zz = np.hstack(z)
        self.ss = np.hstack(s)
        self.CONNECT = np.vstack(connections)
        return self
    
        # Create the points

    
    
    def plot(self):
        src = mlab.pipeline.scalar_scatter(self.xx, self.yy, self.zz, self.ss)
        src.mlab_source.dataset.lines = self.CONNECT
        src.update()
        mlab.pipeline.surface(src, colormap='jet', line_width=1, opacity=.04)
        mlab.show()
        

            
            
            
        