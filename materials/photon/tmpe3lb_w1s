# cython: profile=True


# -*- coding: utf-8 -*-
"""
Created on Sun Nov 29 14:41:41 2020

@author: Rui Campos
"""

from ...tools.data import getAxis
from ...tools.interpolation cimport LinearInterpolation

from numba import njit


def getCS(ID, Z):
    """
    Parameters
    ----------
    ID : tuple
        identifier of cross section table in EPDL
        
    Z : int
        Atomic number of element.

    Returns
    -------
    xAxis : numpy array
        Energy values in MeV.
    yAxis : numpy array
        Cross section values in barn.
        
    TO DO : 
        CHECK UNITS
        place link to EPDL docs
    """
    
    from ..database import EPDL, EADL
    
    #Aw = EADL[Z-1]['Aw']
    
    E, CS = EPDL[Z-1][ID].X, EPDL[Z-1][ID].Y #MeV and Barn
    
    #E, CS = getAxis(CSdata)
    
    #changing units to cm^2
    CS = CS * 1e-24
    
    #lp = LinearInterpolation(Z, E, CS)
    #lp.final_init()
    from ...tools.interpol1 import LinLinInterpolation
    
    return LinLinInterpolation(E, CS)





cdef class IMFP:
    
    cdef list interpolators
    cdef list coefs
    cdef int N
    cdef double Nk
    
    def __init__(self, list interpolators, list coefs, double Nk):
        self.interpolators = interpolators
        self.coefs = coefs
        self.N = len(coefs)
        self.Nk = Nk
    
    cdef double _eval(self, double E):
        cdef double sum = 0
        cdef int i
        for i in range(self.N):
            sum += self.interpolators[i](E)*self.coefs[i]
        
        return sum*self.Nk
    
    def eval(self, double E):
        return self._eval(E)
    
    def __call__(self, double E):
        return self._eval(E)
        



def getMFP(ID, formula, density):
    from ..database import EADL, Na
    
    Am = 0
        
    for Z in formula:
        #print(EADL[Z-1]['Aw'])
        Am += formula[Z]*EADL[Z-1]['Aw']
        
    #print(Am)
        
    Nk  = density * Na / Am #/ 1.660540/1e-24
    
    #K = 1/N

    interpolators = [getCS(ID, Z).eval for Z in formula]
    coefs = list(formula.values())
    N = len(interpolators)


    return IMFP(interpolators, coefs, Nk)



class CSLOGIC:
    def __init__(self, ID, formula, density):
        self.mfp = getMFP(ID, formula, density).eval

# cdef class CSLOGIC:
#     cdef public IMFP mfp
#     """
#     PEMELOPE SECTION: https://drive.google.com/file/d/15gqkmhli03I00n9vdcN5ygDSbBhaWPbg/
#     """
#     def __init__(self, ID, formula, density):
        
#         #from . import CrossSection
#         self.mfp = getMFP(ID, formula, density)

    # @njit
    # def mu(E):
    #     sum = 0
    #     for i in range(N):
    #         sum += interpolators[i](E)*coefs[i]
    #     return sum*Nk
            
        
        
        
    #     #return Nk*sum(interpolators[i](E)*coefs[i] for i in range(N)) 
    
    # return mu


# def getMFP(ID, formula, density):
    
#     from ..database import EADL, Na
    
#     Am = 0
        
#     for Z in formula:
#         Am += formula[Z]*EADL[Z-1]['Aw']
        
        
#     N  = density * Na / Am
#     CS = composeCS(ID, formula)
    
#     def mfp(E):
#         return 1/N/CS(E)
    
#     return mfp